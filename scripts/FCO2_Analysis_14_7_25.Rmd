---
title: "FCO2_Analysis_14_7_25"
author: "Daniel Kaufman"
date: "2025-07-14"
output: html_document
---

```{r setup, include=FALSE}
# working directory to import data
setwd("C:/Users/KAUFMADA/Documents/R_Files/windrow-fluxes-co2-model-improvements/windrow-fluxes-co2-model-improvements/data_clean")

# importing library
library(tidyverse)
library(randomForest)
library(dplyr)
library(nlme)
library(corrplot)
library(reshape2)

#Preparing Data for Analysis

# importing data set
# r^2 cleaned dataset of C02
FCO2_Cleaned<- read_csv("CO2_R_2_Filtered.csv")

#Removing -9999 for data set 
FCO2_Cleaned[FCO2_Cleaned == -9999] <- NA

# Removing variables which either repeat in other places or are not related to FCO2 directly (should I include other fluxes in modeling co2 - such as methane ?)

FCO2_Cleaned <- FCO2_Cleaned %>%
  select(-Date, -DATE_TIME,-R2_flag_8,-R2_flag_9,-R2_flag_95,-N2O_DRY.DEADBAND,-CH4_DRY.DEADBAND,-CO2_DRY.DEADBAND, -OBSERVATION,-FCO2_DRY
         ,-FCO2_DRY.R2,-FCO2_DRY.LIN_R2,-FCH4_DRY.LIN_dCdt,-FCH4_DRY.dCdt, -FCH4_DRY,-FCH4_DRY.LIN_R2,-FCH4_DRY.R2,-FN2O_DRY,-FN2O_DRY.dCdt,
         -FN2O_DRY.R2,-FN2O_DRY.LIN,-FN2O_DRY.LIN_dCdt,-FN2O_DRY.LIN_R2,-CO2_DRY.initial_value,-CO2_DRY.range,-CO2_DRY.mean,-CO2_DRY.DEADBAND,-FCO2_DRY.LIN_dCdt, 
         -FCO2_DRY.dCdt,-VOLUME_TOTAL,-TimeSinceStart,- DOY.initial_value, -N2O_DRY.range, -PORT, -WNS,-N2O_DRY.mean,-N2O_DRY.initial_value,
          -RNF, -Turning_Status, -ET, -H, -TKE, -bowen_ratio, -LE,-WND,-WNG,-TA.mean,-CH4_DRY.mean,-CH4_DRY.initial_value,-CH4_DRY.range,-SWC_1.range,-TS_1.range,-CDOY,-DOY_diff,-i.DOY,-FH2O.LIN,-VPD,-specific_humidity,-air_pressure,-TA.initial_value,-FCH4_DRY.LIN
)

# Normalizing/scaling variables - to more easily see the impact of each variable/ to compare regression coefficients
# not really needed 
df_scaled <- FCO2_Cleaned %>%
  mutate(un_scaled_DOY = DOY) %>%           # Step 1: store original DOY for later ac structure.
  mutate(across(where(is.numeric) & !matches("DOY"), scale))  # Scale all numeric columns except DOY

# factorize categorical variables

df_categorized <- df_scaled %>%
  mutate(across(where(is.character), as.factor))

# checking if they are factorized

sapply(df_categorized, is.factor)

# filling in NA's with median value for that column - open to other ideas to fill in this data. 

df_categorized <- df_categorized %>%
  mutate(across(
    where(is.numeric),
    ~ ifelse(is.na(.), median(., na.rm = TRUE), .)
  ))

```



```{r}

# before choosing variables for the LME lets look at correlation matrix 

# this is a mess, and there are too many variables to properly interpret the results 
numeric_vars <- df_categorized[sapply(df_categorized, is.numeric)]
cor_matrix <- cor(numeric_vars, use = "pairwise.complete.obs", method = "pearson")
corrplot(cor_matrix, method = "color", type = "upper")

# extracting highest cor 
threshold <- 0.7  # you can adjust this

# Set the diagonal to 0 to ignore self-correlation
cor_matrix_no_diag <- cor_matrix
diag(cor_matrix_no_diag) <- 0

# Get variables that have at least one |cor| > threshold
keep_vars <- names(which(apply(abs(cor_matrix_no_diag), 1, function(x) any(x > threshold))))

cor_subset <- cor_matrix[keep_vars, keep_vars]

corrplot(cor_subset, method = "color", order = "hclust", addrect = 2)
cor_long <- melt(cor_subset)

# pairwise list of highest corr in data set
high_corr_pairs <- subset(cor_long, abs(value) > threshold & Var1 != Var2)


```
Correlation Matrix shows pairs which are highly correlated - 

Some relationships are expected. For example total turns will be correlated with DOY and other variables with limited number of measurements will be correlated with DOY (BULK DENSITY. Some other variables relationships were less expected like watchdog soil moisture and DOY. 


```{r}

# Creating a linear model to determine which variables to use in the mixed effects model. 

full_lm <- lm(FCO2_DRY.LIN ~ ., data = df_categorized)
summary(full_lm)

# Key takeaways - Days since turning is important, more important than total turns, 
# bulk density is important, chamber elevation is important. Stevens probe measurements and watchdog data will be part of the model. 
# odd that wind direction matters, is that because of the wind or is that correlated with something? 

# using random forest as well:
# had to change u* name to avoid issues

# TA.range - which is chamber tempurate was an important varaible. Not sure if this is correlation or causation - not sure about this varaible. While it improves the model - im not sure what it represents. 


df_categorized <- df_categorized %>%
  rename(u_star = `u*`)

rf_model <- randomForest(FCO2_DRY.LIN ~ ., data = df_categorized, importance = TRUE, na.action = na.omit)

importance(rf_model)
varImpPlot(rf_model)

```


```{r}

# graphing - TA.range 
Ta_range <- lm(FCO2_DRY.LIN ~ TA.range, data = df_categorized)
summary(Ta_range)


ggplot(FCO2_Cleaned, aes(x = TA.range, y = FCO2_DRY.LIN)) +
  geom_point(alpha = 0.6) +
    geom_smooth(method = "lm", se = TRUE, color = "red") +
  theme_minimal() +
  labs(
    title = "FCO2 vs TA.range",
    x = "Temperature Range (TA.range)",
    y = "COâ‚‚ Flux (FCO2)"
  )

# Positive relationship between airtemp range and flux. Not black and white - worth discussing. 

```


```{r}

# To help with model building removing outliers (being generous with a 2 times IQR could do more as there are likely spikes from turning)

Q1 <- quantile(df_categorized$FCO2_DRY.LIN, 0.25)
Q3 <- quantile(df_categorized$FCO2_DRY.LIN, 0.75)  
iqr_val <- IQR(df_categorized$FCO2_DRY.LIN, na.rm = TRUE)

# this is 2 IQR could change
lower_bound <- Q1 - 2* iqr_val
upper_bound <- Q3 + 2* iqr_val

# Filtering out outliers - can change in the future, but should help with model
Scaled_Cleaned_Co2_data <- df_categorized[df_categorized$FCO2_DRY.LIN >= lower_bound & df_categorized$FCO2_DRY.LIN <= upper_bound, ]

# creating the base model.

# Variable choice: DOY - why should DOY be part of this model, I'm removing it: 
# Pile 
# Initial Soil Water Content from Steven's Probe
# Initial Temperature value from the Steven's Probe
# TMP - outside temp 
# BAR - pressure 
# HMD - Humidity
# Total Turns
# Bulk Density 
# Chamber Elevation 

lme_base_model <- lme(
  FCO2_DRY.LIN ~ Pile + SWC_1.initial_value + TS_1.initial_value +
    TMP + BAR + BulkDensity + Chamber_Elevation +
    DaysSinceLastTurn + TotalTurns + HMD,
  random = ~ 1 | Chamber_Corrected,
  data = Scaled_Cleaned_Co2_data,
  na.action = na.omit
)

summary(lme_base_model)
plot(lme_base_model)
qqnorm(lme_base_model)


lme_base_model_pile_chamber <- lme(
  FCO2_DRY.LIN ~ SWC_1.initial_value + TS_1.initial_value +
    TMP + BAR + BulkDensity + Chamber_Elevation +
    DaysSinceLastTurn + TotalTurns + HMD,
  random = ~ 1 | Pile,
  data = Scaled_Cleaned_Co2_data,
  na.action = na.omit
)

summary(lme_base_model_pile)
plot(lme_base_model_pile)
qqnorm(lme_base_model_pile)

# based on these results there are some interesting talking points 

# Pile was not useful, but this is not so surpising - other variables explain the difference in emissions better than pile.

# When chamber is the random effect BAR and Bulk density add to the model, yet when pile is used as a random effect (which I do not think makes sense) they stop being significant. Why is that ? 
```
There are some interesting things going on here that I do not fully understand: 

Above we have two mixed effects models one with Pile as an explanatory varaible and chamber as the random effect - which to me makes the most sense. The chambers as the repeatly measured individuals and the pile is the effect we are trying to measure. I have continued to use this model. 


```{r}

# the reduced model does not include pile (as it did not impact preformance), but is a similar set of vars (many of which might be correlated),
# like soil moisture and HMD ect. 

lme_base_mode_reduced <- lme(
  FCO2_DRY.LIN ~ SWC_1.initial_value + TS_1.initial_value + TMP + BulkDensity + Chamber_Elevation + HMD +
    DaysSinceLastTurn,
  random = ~ 1 | Chamber_Corrected,
  data = Scaled_Cleaned_Co2_data,
  na.action = na.omit
)

summary(lme_base_mode_reduced)
plot(lme_base_model)
qqnorm(lme_base_model)

# as we did not lose explanatory power, lets use the reduced model moving forward as it is more simple:
# for auto correlation we will use DOY - but unscaled to avoid negative values: 
```
```{r}

# as we did not lose much explanatory power, lets use the reduced model moving forward as it is more simple:
# for auto correlation we will use DOY - but unscaled to avoid negative values: 

Scaled_Cleaned_Co2_data %>%
  group_by(Chamber_Corrected) %>%
  arrange(DOY, .by_group = TRUE) %>%
  summarise(repeats = any(duplicated(DOY)))

# while dates don't repeat, for the scaled date there are some repeats which we have to get rid of for autocorrelation.

Scaled_Cleaned_Co2_data <- Scaled_Cleaned_Co2_data %>%
  group_by(Chamber_Corrected, un_scaled_DOY) %>%
  filter(row_number() == 1) %>%  # Keep only first occurrence
  ungroup()

Scaled_Cleaned_Co2_data <- Scaled_Cleaned_Co2_data %>%
  mutate(un_scaled_DOY = as.numeric(unlist(un_scaled_DOY)))

Scaled_Cleaned_Co2_data <- Scaled_Cleaned_Co2_data %>%
  arrange(Chamber_Corrected, un_scaled_DOY) %>%
  group_by(Chamber_Corrected) %>%
  mutate(measurement_index = row_number()) %>%
  ungroup()

# Add AR(1) autocorrelation structure based on DOY (or time variable) - by chamber not as a whole.
lme_ac <- update(
  lme_base_mode_reduced,
  correlation = corAR1(form = ~ measurement_index | Chamber_Corrected)
)

# letting variance change by pile: 
lme_var_pile <- update(lme_base_mode_reduced, weights = varIdent(form = ~1 | Pile))

# letting variance change by chamber: 
lme_var_chamber <- update(lme_base_mode_reduced, weights = varIdent(form = ~1 | Chamber_Corrected))

# Compare the models
BIC(lme_base_mode_reduced,lme_ac, lme_var_pile, lme_var_chamber)

# the BIC fo the adding AC improves alot. Out of the adding different variances, it only improves the model fit with chamber. 

# combining ac and var 

lme_ac_var <- update(
  lme_ac,
  weights = varIdent(form = ~1 | Chamber_Corrected),
  control = lmeControl(maxIter = 100, msMaxIter = 100, niterEM = 50)
)

# comparing the added ac_var model 

BIC(lme_base_mode_reduced,lme_var_chamber, lme_ac,lme_ac_var)
summary(lme_ac_var)
plot(lme_ac_var)
qqnorm(resid(lme_ac_var))
qqline(resid(lme_ac_var))

# best model is the var ( chamber) and auto- correlation (chamber)

lme_final_with_pile <- update(
  lme_ac_var,
  . ~ . + Pile
)

summary(lme_final_with_pile)

# adding pile makes the model worse
# pile was not an important factor yet other factors that are associated with management are important 

# SWC, TS, DaysSinceLastTurn, Total_Turns etc

# Points of Further Discussion
# Here I'm treating chambers individually, is that a mistake? Does this mask the effect of pile ? 
# Examine Chamber vs Pile - are we masking the effect of Pile management ? 

# Most importantly - what exactly do we want to say about management - rate of emissions do not seems to be correlated to Pile, but more on other environmental variables at a give point in time, but relationship might be shorter term (days since last turn) when there is still plenty of substrate ? IDK. 

```
