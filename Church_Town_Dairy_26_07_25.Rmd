---
title: "CTD_26_07_2025"
output: html_document
date: "2025-07-26"
---

```{r setup, include=FALSE}
# working directory to import data
setwd("C:/Users/KAUFMADA/Documents/R_Files/windrow-fluxes-co2-model-improvements/windrow-fluxes-co2-model-improvements/data_clean")

# importing library
library(tidyverse)
library(randomForest)
library(dplyr)
library(nlme)
library(corrplot)
library(reshape2)

#Preparing Data for Analysis

# importing data set
# r^2 cleaned dataset of C02
FCO2_Cleaned<- read_csv("CO2_R_2_Filtered.csv")

#Removing -9999 for data set 
FCO2_Cleaned[FCO2_Cleaned == -9999] <- NA
```
This R markdown document is a draft of the analysis of 2023 emissions data from Churchtown Dairy's composting windrows. A control pile and experimental pile were turned at different rates, and emissions/physical properties measured. The control pile was turned every 2 weeks and the experimental pile every 4 weeks during the summer and fall of 2023.

Research Question: How does turning frequency influence properties of compost windrows over time, and how do these properties explain trace gas emissions (e.g., CO₂, CH₄, N₂O) in both control and treatment piles?

To improve understanding of the underlying data here are a series of visual representations of physical and chemical properties of the composting windrows throughout the experimental cycle:

Figure 1: Rate of emissions of carbon dioxide throughout the experimental cycle - lines represent turning dates: Color of lines represent treatment: 
```{r}

Co2_plot_by_chamber <- ggplot(FCO2_Cleaned, aes(x= DOY, y = FCO2_DRY.LIN, group = Chamber_Corrected, color = Pile)) +
  geom_point() +
  
      # Vertical lines for sampling events
  geom_vline(xintercept = c( 173, 191, 222, 249, 276), 
             linetype = "dashed", color = "black", size = 0.2) +
  
  # Vertical lines for turning events
  geom_vline(xintercept = c(159, 186, 208, 234, 262, 290), 
             linetype = "dashed", color = "red", size = 0.8) +

  labs(
    title = " Carbon Dioxide Flux",
    subtitle = "Chamber Fluxes by Treatment Group",
    x = "Day of Year (DOY)",
    y = expression(CO[2]~Flux~(umol~m^{-2}~s^{-1})),
    color = "Turning Regime"
  ) +
  
 # Theme customization
  theme_classic(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold"),
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    legend.key.width = unit(1.5, "cm")
  )

# Display the plot
print(Co2_plot_by_chamber)
```


Note: Read dashed lines are turning of both the experimental and control piles. Black dashed lines represent turning only the control pile. During turning events spikes in emissions are apparent.

Let's look at this for each individual Chamber to see if we see similar trends across Chamber: 

```{r}
library(ggplot2)

Co2_plot_by_chamber <- ggplot(FCO2_Cleaned, aes(x = DOY, y = FCO2_DRY.LIN, color = Pile)) +
  
  # Points per chamber
  geom_point(aes(group = Chamber_Corrected), size = 2, alpha = 0.7) +
  
      # Vertical lines for sampling events
  geom_vline(xintercept = c( 173, 191, 222, 249, 276), 
             linetype = "dashed", color = "black", size = 0.2) +
  
  # Vertical lines for turning events
  geom_vline(xintercept = c(159, 186, 208, 234, 262, 290), 
             linetype = "dashed", color = "red", size = 0.8) +


  # Facet by chamber
  facet_wrap(~ Chamber_Corrected, ncol = 2, scales = "free_y") +

  # Labels
  labs(
    title = "Carbon Dioxide Flux",
    subtitle = "Chamber Fluxes by Treatment Group",
    x = "Day of Year (DOY)",
    y = expression(CO[2]~Flux~(μmol~m^{-2}~s^{-1})),  # using μmol instead of 'umol'
    color = "Turning Regime"
  ) +
  
  # Theme
  theme_classic(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold"),
    strip.text = element_text(size = 12),
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    legend.key.width = unit(1.5, "cm")
  )

# Display the plot
print(Co2_plot_by_chamber)

```

To improve interpretability of emissions data - weekly averages have also been plotted.

```{r}
# creating weekly average: 

FCO2_weekly <-  FCO2_Cleaned %>%
  mutate(Week = floor(DOY/7)) %>%
  group_by(Pile, Chamber_Corrected, Week) %>%
    summarise(
        FCO2_weekly_mean = mean(FCO2_DRY.LIN, na.rm = TRUE),
    .groups = "drop"
  )
   
```


```{r}

library(ggplot2)

Co2_plot_weekly <- ggplot(FCO2_weekly, aes(x = Week, y = FCO2_weekly_mean, color = Pile)) +
  
  # Points for weekly average per chamber
  geom_point(aes(group = Chamber_Corrected), size = 2, alpha = 0.7) +
  
  # Optional: Add smoother if desired later, e.g., geom_smooth(method = "loess", se = FALSE)
  
  # Vertical lines for events (convert DOY to weeks for alignment)
  geom_vline(xintercept = floor(c(159, 173, 186, 191, 208, 222, 234, 249, 262, 276, 290) / 7), 
             linetype = "dashed", color = "black", size = 0.3) +
  geom_vline(xintercept = floor(c(159, 186, 208, 234, 262, 290) / 7), 
             linetype = "dashed", color = "red", size = 0.4) +

  labs(
    title = "Weekly-Averaged Carbon Dioxide Flux by Chamber",
    subtitle = "Grouped by Treatment Regime",
    x = "Week of Year",
    y = expression(CO[2]~Flux~(μmol~m^{-2}~s^{-1})),
    color = "Turning Regime"
  ) +
  
  theme_classic(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold"),
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    legend.key.width = unit(1.5, "cm")
  )

print(Co2_plot_weekly)



```

Separating by chamber shows the spatial heterogeneity of the pile. To better understand larger trends between treatments not chambers, here is the average by treatment group, not chamber.

```{r}
# creating weekly average: 

FCO2_weekly_pile <-  FCO2_Cleaned %>%
  mutate(Week = floor(DOY/7)) %>%
  group_by(Pile, Week) %>%
    summarise(
        FCO2_weekly_mean = mean(FCO2_DRY.LIN, na.rm = TRUE),
    .groups = "drop"
  )
   
```

```{r}
library(ggplot2)

Co2_plot_weekly_pile <- ggplot(FCO2_weekly_pile, aes(x = Week, y = FCO2_weekly_mean, color = Pile)) +
  
  # Points for weekly average per chamber
  geom_point(aes(group = Pile), size = 2, alpha = 0.7) +
  
  # Optional: Add smoother if desired later, e.g., geom_smooth(method = "loess", se = FALSE)
  
  # Vertical lines for events (convert DOY to weeks for alignment)
  geom_vline(xintercept = floor(c(159, 173, 186, 191, 208, 222, 234, 249, 262, 276, 290) / 7), 
             linetype = "dashed", color = "black", size = 0.3) +
  geom_vline(xintercept = floor(c(159, 186, 208, 234, 262, 290) / 7), 
             linetype = "dashed", color = "red", size = 0.4) +

  labs(
    title = "Weekly-Averaged Carbon Dioxide Flux by Treatment",
    subtitle = "Grouped by Treatment Regime",
    x = "Week of Year",
    y = expression(CO[2]~Flux~(μmol~m^{-2}~s^{-1})),
    color = "Turning Regime"
  ) +
  
  theme_classic(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold"),
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    legend.key.width = unit(1.5, "cm")
  )

print(Co2_plot_weekly_pile)

```

A line can also be added to show trends: 

```{r}
library(ggplot2)

Co2_plot_weekly_pile_line <- ggplot(FCO2_weekly_pile, aes(x = Week, y = FCO2_weekly_mean, color = Pile)) +
  
  # Points for weekly average per chamber
  geom_point(aes(group = Pile), size = 2, alpha = 0.7) +
    geom_line(aes(group = Pile), linewidth = 1) +

  
  # Optional: Add smoother if desired later, e.g., geom_smooth(method = "loess", se = FALSE)
  
  # Vertical lines for events (convert DOY to weeks for alignment)
  geom_vline(xintercept = floor(c(159, 173, 186, 191, 208, 222, 234, 249, 262, 276, 290) / 7), 
             linetype = "dashed", color = "black", size = 0.3) +
  geom_vline(xintercept = floor(c(159, 186, 208, 234, 262, 290) / 7), 
             linetype = "dashed", color = "red", size = 0.4) +

  labs(
    title = "Weekly-Averaged Carbon Dioxide Flux by Treatment",
    subtitle = "Grouped by Treatment Regime",
    x = "Week of Year",
    y = expression(CO[2]~Flux~(μmol~m^{-2}~s^{-1})),
    color = "Turning Regime"
  ) +
  
  theme_classic(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold"),
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    legend.key.width = unit(1.5, "cm")
  )

print(Co2_plot_weekly_pile_line)

```
Moving on from Carbon Dioxide - the same graphs are created for each trace gas (still need to clean these gases)

Here we see towards then end of the cycle a marked difference in emissions of co2 from the control and the experimental with the hypothetically more areated control pile emitting more co2 and if you look at the temp graph also warmer.

Lets move on to methane: 

```{r}
# this is a quick methane cleaning: not the actual cleaning - that will be done separately
# note these are only points that also have co2 - Im going to clean the other gases as there may be values that have poor co2 values but good ch4 values

Methane_data_for_plots <- FCO2_Cleaned %>%
  filter(FCH4_DRY.LIN_R2 > 0.9 & FCH4_DRY.LIN > 0)

Methane_plot_points <- ggplot(Methane_data_for_plots, aes(x= DOY, y = FCH4_DRY.LIN, group = Chamber_Corrected, color = Pile)) +
  geom_point() +
  
      # Vertical lines for sampling events
  geom_vline(xintercept = c(159, 173, 186, 191, 208, 222, 234, 249, 262, 276, 290), 
             linetype = "dashed", color = "black", size = 0.3) +
  
  # Vertical lines for turning events
  geom_vline(xintercept = c(159, 186, 208, 234, 262, 290), 
             linetype = "dashed", color = "red", size = 0.4) +

  labs(
    title = " Methane Flux",
    subtitle = "Chamber Fluxes by Treatment Group",
    x = "Day of Year (DOY)",
    y = expression(Ch[4]~Flux~(nmol~m^{-2}~s^{-1})),
    color = "Turning Regime"
  ) +
  
 # Theme customization
  theme_classic(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold"),
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    legend.key.width = unit(1.5, "cm")
  )

# Display the plot
print(Methane_plot_points)
```
Similiar to co2 lets look at chambers individually

```{r}

Ch4_plot_by_chamber <- ggplot(Methane_data_for_plots, aes(x = DOY, y = FCH4_DRY.LIN, color = Pile)) +
  
  # Points per chamber
  geom_point(aes(group = Chamber_Corrected), size = 2, alpha = 0.7) +
  
  # Sampling events
  geom_vline(xintercept = c(159, 173, 186, 191, 208, 222, 234, 249, 262, 276, 290),
             linetype = "dashed", color = "black", size = 0.3) +
  
  # Turning events
  geom_vline(xintercept = c(159, 186, 208, 234, 262, 290),
             linetype = "dashed", color = "red", size = 0.4) +

  # Facet by chamber
  facet_wrap(~ Chamber_Corrected, ncol = 2, scales = "free_y") +

  # Labels
  labs(
    title = "Methane  Flux",
    subtitle = "Chamber Fluxes by Treatment Group",
    x = "Day of Year (DOY)",
    y = expression(Ch[4]~Flux~(nmol~m^{-2}~s^{-1})),  # using μmol instead of 'umol'
    color = "Turning Regime"
  ) +
  
  # Theme
  theme_classic(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold"),
    strip.text = element_text(size = 12),
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    legend.key.width = unit(1.5, "cm")
  )

# Display the plot
print(Ch4_plot_by_chamber)

```
```{r}
# creating weekly average by pile: 

Weekly_ch4_Chambers_pile <-  Methane_data_for_plots %>%
  mutate(Week = floor(DOY/7)) %>%
  group_by(Pile, Week) %>%
    summarise(
        weekly_ch4_by_chamber = mean(FCH4_DRY.LIN, na.rm = TRUE),
    .groups = "drop"
  )

Ch4_plot_weekly_pile_line <- ggplot(Weekly_ch4_Chambers_pile, aes(x = Week, y = weekly_ch4_by_chamber, color = Pile)) +
  
  # Points for weekly average per chamber
  geom_point(aes(group = Pile), size = 2, alpha = 0.7) +
    geom_line(aes(group = Pile), linewidth = 1) +

  
  # Optional: Add smoother if desired later, e.g., geom_smooth(method = "loess", se = FALSE)
  
  # Vertical lines for events (convert DOY to weeks for alignment)
  geom_vline(xintercept = floor(c(159, 173, 186, 191, 208, 222, 234, 249, 262, 276, 290) / 7), 
             linetype = "dashed", color = "black", size = 0.3) +
  geom_vline(xintercept = floor(c(159, 186, 208, 234, 262, 290) / 7), 
             linetype = "dashed", color = "red", size = 0.4) +

  labs(
    title = "Weekly-Averaged Methane Flux by Treatment",
    subtitle = "Grouped by Treatment Regime",
    x = "Week of Year",
    y = expression(CH[4]~Flux~(nmol~m^{-2}~s^{-1})),
    color = "Turning Regime"
  ) +
  
  theme_classic(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold"),
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    legend.key.width = unit(1.5, "cm")
  )

print(Ch4_plot_weekly_pile_line)

   
```
Visually this is interesting, while the higher co2 values fit with the hypothesis of more aeration with higher turning frequency - the high ch4 emissions do not as we would expect a lower ch4 emissions, this does not appear to be the case. Overall the more turns the more emissions visually, though that might not be significant. 

Let's move on to other variables, starting with temperature: 

```{r}

Temp_by_chamber_plot <- ggplot(FCO2_Cleaned, aes(x = DOY, y = TS_1.initial_value,group = Chamber_Corrected, color = Pile)) +
  
  geom_point(aes(group = Chamber_Corrected), size = 2, alpha = 0.7) +
  
    geom_vline(xintercept = floor(c(159, 173, 186, 191, 208, 222, 234, 249, 262, 276, 290)), 
             linetype = "dashed", color = "black", size = 0.3) +
  geom_vline(xintercept = floor(c(159, 186, 208, 234, 262, 290)), 
             linetype = "dashed", color = "red", size = 0.4) +

  labs(
    title = "Temperature under Chamber by Treatment",
    subtitle = "Grouped by Treatment Regime",
    x = "DOY",
    y = "Temp C",
    color = "Turning Regime"
  ) +
  
  theme_classic(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold"),
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    legend.key.width = unit(1.5, "cm")
  )

print(Temp_by_chamber_plot)


```

Another version with seperate chambers: 

```{r}
library(ggplot2)

Temp_by_chamber_plot <- ggplot(FCO2_Cleaned, aes(x = DOY, y = TS_1.initial_value, color = Pile)) +
  
  # Points by chamber
  geom_point(aes(group = Chamber_Corrected), size = 2, alpha = 0.7) +
  
  # Sampling events
  geom_vline(xintercept = floor(c(159, 173, 186, 191, 208, 222, 234, 249, 262, 276, 290)), 
             linetype = "dashed", color = "black", size = 0.3) +
  
  # Turning events
  geom_vline(xintercept = floor(c(159, 186, 208, 234, 262, 290)), 
             linetype = "dashed", color = "red", size = 0.4) +

  # Facet by chamber
  facet_wrap(~ Chamber_Corrected, ncol = 2, scales = "free_y") +

  # Labels and formatting
  labs(
    title = "Chamber Temperature by Treatment",
    subtitle = "Faceted by Chamber, Colored by Treatment",
    x = "Day of Year (DOY)",
    y = "Temperature (°C)",
    color = "Turning Regime"
  ) +
  
  theme_classic(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold"),
    strip.text = element_text(size = 12),
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    legend.key.width = unit(1.5, "cm")
  )

# Display the plot
print(Temp_by_chamber_plot)

```


As with other graphs - it is useful to simplify and average for ease of interpretability: 
Here we average the temperature by week for each chamber separately

```{r}
# creating weekly average: 

Weekly_Temp_Chambers <-  FCO2_Cleaned %>%
  mutate(Week = floor(DOY/7)) %>%
  group_by(Pile,Chamber_Corrected, Week) %>%
    summarise(
        weekly_temp_by_chamber = mean(TS_1.initial_value, na.rm = TRUE),
    .groups = "drop"
  )
   
```

```{r}
library(ggplot2)

Temp_by_chamber_weekly <- ggplot(Weekly_Temp_Chambers, aes(x = Week, y = weekly_temp_by_chamber, group = Chamber_Corrected,color = Pile)) +
  
  # Points for weekly average per chamber
  geom_point(aes(group = Chamber_Corrected), size = 2, alpha = 0.7) +
  
  # Optional: Add smoother if desired later, e.g., geom_smooth(method = "loess", se = FALSE)
  
  # Vertical lines for events (convert DOY to weeks for alignment)
  geom_vline(xintercept = floor(c(159, 173, 186, 191, 208, 222, 234, 249, 262, 276, 290) / 7), 
             linetype = "dashed", color = "black", size = 0.3) +
  geom_vline(xintercept = floor(c(159, 186, 208, 234, 262, 290) / 7), 
             linetype = "dashed", color = "red", size = 0.4) +

  labs(
    title = "Weekly Average Temperature by Treatment (individual Chamber values)",
    subtitle = "Grouped by Treatment Regime",
    x = "Week of Year",
    y = "Temp C",
    color = "Turning Regime"
  ) +
  
  theme_classic(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold"),
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    legend.key.width = unit(1.5, "cm")
  )

print(Temp_by_chamber_weekly)

```

If we average by pile not chamber we get the following result: 

```{r Daily average temp by treatment plot start}
# creating weekly average by pile: 

daily_temp_by_pile <-  FCO2_Cleaned %>%
  mutate(day = floor(DOY/1)) %>%
  group_by(Pile, day) %>%
    summarise(
        daily_temp_by_pile = mean(TS_1.initial_value, na.rm = TRUE),
    .groups = "drop"
  )
   
```

```{r}
install.packages("showtext")

library(ggplot2)
library(showtext)

# Load font (you must have Times New Roman installed on your system)
font_add("Times New Roman", regular = "Times New Roman.ttf") # path if needed
showtext_auto()
```

```{r warning=FALSE}
library(ggplot2)

daily_temp_by_pile_plot <- ggplot(daily_temp_by_pile, aes(x = day, y = daily_temp_by_pile, group = Pile ,color = Pile)) +
  
  # Points for weekly average per chamber
  geom_point(aes(group = Pile), size = 2, alpha = 0.7) +


  # Vertical lines for events (convert DOY to weeks for alignment)
  geom_vline(xintercept = floor(c(159, 173, 186, 191, 208, 222, 234, 249, 262, 276, 290)), 
             linetype = "dashed", color = "black", size = 0.3) +
  geom_vline(xintercept = floor(c(159, 186, 208, 234, 262, 290)), 
             linetype = "dashed", color = "red", size = 0.4) +

  labs(
    title = "Daily Average Temperature by Treatment (Pile)",
    subtitle = "Grouped by Treatment Regime",
    x = "Day of Year",
    y = "Temp C",
    color = "Turning Regime"
  ) +
  
  theme_classic(base_family = "Times New Roman") +
  theme(
    plot.title = element_text(face = "bold"),
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    legend.key.width = unit(1.5, "cm")
  )

print(daily_temp_by_pile_plot)

```
Here a lower temp for the experimental pile fits with the lower emissions seen both the ch4 and co2 data towards the end of the experimental cycle. 

Moving on to Soil Water Content measured in each Pile SWC

```{r}

SWC_by_chamber_plot <- ggplot(FCO2_Cleaned, aes(x = DOY, y = SWC_1.initial_value ,group = Chamber_Corrected, color = Pile)) +
  
  geom_point(aes(group = Chamber_Corrected), size = 2, alpha = 0.7) +
  
    geom_vline(xintercept = floor(c(159, 173, 186, 191, 208, 222, 234, 249, 262, 276, 290)), 
             linetype = "dashed", color = "black", size = 0.3) +
  geom_vline(xintercept = floor(c(159, 186, 208, 234, 262, 290)), 
             linetype = "dashed", color = "red", size = 0.4) +

  labs(
    title = "SWC under Chamber by Treatment",
    subtitle = "Grouped by Treatment Regime",
    x = "DOY",
    y = "[m+3m-3]",
    color = "Turning Regime"
  ) +
  
  theme_classic(base_family = "Times New Roman") +
  theme(
    plot.title = element_text(face = "bold"),
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    legend.key.width = unit(1.5, "cm")
  )

print(SWC_by_chamber_plot)


```

Something is up here - lets look at these individually to see if we can figure out what is going on. I took a look at the values and there are many that are .95 - I find it unlikely that so many values are exactly the same - I'm going to remove values of .95 as I believe they indicate an error with the sensor: 

```{r}

FCO2_Cleaned <- FCO2_Cleaned %>%
  mutate(SWC_1.initial_value = ifelse(SWC_1.initial_value > 0.9, NA, SWC_1.initial_value))

```


```{r}
library(ggplot2)

SWC_by_chamber_plot <- ggplot(FCO2_Cleaned, aes(x = DOY, y = SWC_1.initial_value, color = Pile)) +
  
  # Points per chamber
  geom_point(aes(group = Chamber_Corrected), size = 2, alpha = 0.7) +

  # Vertical lines: black for sampling
  geom_vline(xintercept = floor(c(159, 173, 186, 191, 208, 222, 234, 249, 262, 276, 290)), 
             linetype = "dashed", color = "black", size = 0.3) +
  
  # Vertical lines: red for turning
  geom_vline(xintercept = floor(c(159, 186, 208, 234, 262, 290)), 
             linetype = "dashed", color = "red", size = 0.4) +

  # Labels and formatting
  labs(
    title = "Soil Water Content (SWC) Under Each Chamber",
    subtitle = "Faceted by Chamber, Colored by Treatment",
    x = "Day of Year (DOY)",
    y = "SWC (m³ m⁻³)",
    color = "Turning Regime"
  ) +
  
  # Facet by chamber
  facet_wrap(~ Chamber_Corrected, ncol = 2) +  # Try ncol = 2 or 3 for layout
  
  theme_classic(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold"),
    strip.text = element_text(size = 12),  # chamber labels
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    legend.key.width = unit(1.5, "cm")
  )

# Display the plot
print(SWC_by_chamber_plot)

```

There seems to be more variability in the control pile with the experimental pile having much higher SWC over time - with values close to 1 for large swathes of time. When values > .95 removed there is not much continous data for the experimental pile. 


```{r Daily SWC Plot, warning=FALSE}

FCO2_Cleaned_SWC_weekly_pile <-  FCO2_Cleaned %>%
 mutate(day = floor(DOY/1)) %>%
  group_by(Pile, day) %>%
  summarise(
        daily_swc_by_pile = mean(SWC_1.initial_value, na.rm = TRUE),
    .groups = "drop"
  )

FCO2_Cleaned_SWC_weekly_pile_plot <- ggplot(FCO2_Cleaned_SWC_weekly_pile, aes(x = day , y = daily_swc_by_pile ,group = Pile, color = Pile)) +
  
  geom_point(aes(group = Pile), size = 2, alpha = 0.7) +
  
  # Vertical lines for events (convert DOY to weeks for alignment)
  geom_vline(xintercept = floor(c(159, 173, 186, 191, 208, 222, 234, 249, 262, 276, 290) ), 
             linetype = "dashed", color = "black", size = 0.3) +
  geom_vline(xintercept = floor(c(159, 186, 208, 234, 262, 290) ), 
             linetype = "dashed", color = "red", size = 0.4) +
  labs(
    title = "Daily Average Volumetric Moisture Content",
    subtitle = "Grouped by Treatment Regime",
    x = "DOY",
    y = "meter^3 water/m^3 soil",
    color = "Turning Regime"
  ) +
  
  theme_classic(base_family = "Times New Roman") +
  theme(
    plot.title = element_text(face = "bold"),
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    legend.key.width = unit(1.5, "cm")
  )

print(FCO2_Cleaned_SWC_weekly_pile_plot)

```



```{r}
library(dplyr)

FCO2_Cleaned %>%
  filter(!is.na(SWC_1.initial_value)) %>%       # Remove NA values
  group_by(Pile) %>%                     # Group by Control/Experimental
  summarise(mean_TS = mean(SWC_1.initial_value))  # Calculate mean
```



























What if we look at FH20

```{r}

FCO2_Cleaned_H2O <- FCO2_Cleaned %>%
  mutate(FH2O = ifelse(FH2O < 0, NA, FH2O))

```
```{r}

FH2O_plot <- ggplot(FCO2_Cleaned_H2O, aes(x = DOY, y = FH2O ,group = Chamber_Corrected, color = Pile)) +
  
  geom_point(aes(group = Chamber_Corrected), size = 2, alpha = 0.7) +
  
    geom_vline(xintercept = floor(c(159, 173, 186, 191, 208, 222, 234, 249, 262, 276, 290)), 
             linetype = "dashed", color = "black", size = 0.3) +
  geom_vline(xintercept = floor(c(159, 186, 208, 234, 262, 290)), 
             linetype = "dashed", color = "red", size = 0.4) +

  labs(
    title = "FH2O by Treatment",
    subtitle = "Grouped by Treatment Regime",
    x = "DOY",
    y = "[Moles h20 _ not sure units will check]",
    color = "Turning Regime"
  ) +
  
  theme_classic(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold"),
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    legend.key.width = unit(1.5, "cm")
  )

print(FH2O_plot)


```

Averaging by week/pile 

```{r}

# creating weekly average by pile: 

FCO2_Cleaned_H2O_weekly <-  FCO2_Cleaned_H2O %>%
  mutate(Week = floor(DOY/7)) %>%
  group_by(Pile, Week) %>%
    summarise(
        weekly_fh2o_by_chamber = mean(FH2O, na.rm = TRUE),
    .groups = "drop"
  )

FH2O_plot_weekly <- ggplot(FCO2_Cleaned_H2O_weekly, aes(x = Week, y = weekly_fh2o_by_chamber ,group = Pile, color = Pile)) +
  
  geom_point(aes(group = Pile), size = 2, alpha = 0.7) +
  
  # Vertical lines for events (convert DOY to weeks for alignment)
  geom_vline(xintercept = floor(c(159, 173, 186, 191, 208, 222, 234, 249, 262, 276, 290) / 7), 
             linetype = "dashed", color = "black", size = 0.3) +
  geom_vline(xintercept = floor(c(159, 186, 208, 234, 262, 290) / 7), 
             linetype = "dashed", color = "red", size = 0.4) +
  labs(
    title = "FH20 weekly by Treatment",
    subtitle = "Grouped by Treatment Regime",
    x = "DOY",
    y = "[Moles h20 _ not sure units will check]",
    color = "Turning Regime"
  ) +
  
  theme_classic(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold"),
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    legend.key.width = unit(1.5, "cm")
  )

print(FH2O_plot_weekly)



```


These values are hard to interpret - I have concerns over them.Lets look at the more discrete lab measured moisture content:

```{r}
Moisture_data <- read.csv("C:/Users/KAUFMADA/Documents/CTD/Moisture_Content_2023.csv")
```

```{r gravametric moisture graph }
Oven_moisture_data_plot <- ggplot(Moisture_data, aes(x = DOY, y = Moisture, color = Pile)) +
  
  # Points per chamber
  geom_point(aes(group = Pile), size = 2, alpha = 0.7) +

  # Vertical lines: black for sampling
  geom_vline(xintercept = floor(c(159, 173, 186, 191, 208, 222, 234, 249, 262, 276, 290)), 
             linetype = "dashed", color = "black", size = 0.3) +
  
  # Vertical lines: red for turning
  geom_vline(xintercept = floor(c(159, 186, 208, 234, 262, 290)), 
             linetype = "dashed", color = "red", size = 0.4) +

  # Labels and formatting
  labs(
    title = "Soil Water Content (SWC) by Pile",
    subtitle = " Colored by Treatment",
    x = "Day of Year (DOY)",
    y = "Moisture %",
    color = "Turning Regime"
  ) +
  
  theme_classic(base_family = "Times New Roman") +

  theme(
    plot.title = element_text(face = "bold"),
    strip.text = element_text(size = 12),  # chamber labels
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    legend.key.width = unit(1.5, "cm")
  )

# Display the plot
print(Oven_moisture_data_plot)
```

It is hard to compare the two given the units are different - but we do NOT see the same trend of the Experimental pile having a higher moisture content as in the SWC sensor data. Further discussion of SWC is warranted - and cleaning needed this is something we can discuss as a group. The control pile which is turned more frequently having higher moisture content is not expected. The only explanation I can think of is turning redistributes the moisture, and the outer layer of the experimental pile is more dried out, yet as these measurements occured after turning, that would not explain this data. 


```{r}
library(dplyr)

Moisture_data %>%
  filter(!is.na(Moisture)) %>%       # Remove NA values
  group_by(Pile) %>%                     # Group by Control/Experimental
  summarise(mean_moisture = mean(Moisture))  # Calculate mean
```

Creating a plot the Dry Bulk Density:

```{r}

Dry_Bulk_Density_File <- readxl::read_xlsx("C:/Users/KAUFMADA/Documents/R_Files/windrow-fluxes-co2-model-improvements/windrow-fluxes-co2-model-improvements/data_raw/DRY_bd.xlsx")


Dry_Bulk_Density_data_plot <- ggplot(Dry_Bulk_Density_File, aes(x = DOY, y = Dry_Bulk_Density_File$`Dry BD` , color = Pile)) +
  
  # Points per chamber
  geom_point(aes(group = Pile), size = 2, alpha = 0.7) +

  # Vertical lines: black for sampling
  geom_vline(xintercept = floor(c(159, 173, 186, 191, 208, 222, 234, 249, 262, 276, 290)), 
             linetype = "dashed", color = "black", size = 0.3) +
  
  # Vertical lines: red for turning
  geom_vline(xintercept = floor(c(159, 186, 208, 234, 262, 290)), 
             linetype = "dashed", color = "red", size = 0.4) +

  # Labels and formatting
  labs(
    title = "Dry Bulk Density Pile",
    subtitle = " Colored by Treatment",
    x = "Day of Year (DOY)",
    y = "grams per cm3",
    color = "Turning Regime"
  ) +
  
  
  theme_classic(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold"),
    strip.text = element_text(size = 12),  # chamber labels
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    legend.key.width = unit(1.5, "cm")
  )

# Display the plot
print(Dry_Bulk_Density_data_plot)
```

```{r}
library(dplyr)

Dry_Bulk_Density_File %>%
  group_by(Pile) %>%                     # Group by Control/Experimental
  summarise(mean_moisture = mean(`Dry BD`))  # Calculate mean

```













Moving on to Bulk Density,Chamber elevation, 2d,3d surface area and volume. 

```{r}
Bulk_Density_Data <- read.csv("C:/Users/KAUFMADA/Documents/R_Files/windrow-fluxes-co2-model-improvements/windrow-fluxes-co2-model-improvements/data_raw/BD_2023.csv")

```

```{r}

Bulk_Density_data_plot <- ggplot(Bulk_Density_Data, aes(x = DOY, y = grams.cm.3, color = Pile)) +
  
  # Points per chamber
  geom_point(aes(group = Pile), size = 2, alpha = 0.7) +

  # Vertical lines: black for sampling
  geom_vline(xintercept = floor(c(159, 173, 186, 191, 208, 222, 234, 249, 262, 276, 290)), 
             linetype = "dashed", color = "black", size = 0.3) +
  
  # Vertical lines: red for turning
  geom_vline(xintercept = floor(c(159, 186, 208, 234, 262, 290)), 
             linetype = "dashed", color = "red", size = 0.4) +

  # Labels and formatting
  labs(
    title = "Bulk Density Pile",
    subtitle = " Colored by Treatment",
    x = "Day of Year (DOY)",
    y = "grams per cm3",
    color = "Turning Regime"
  ) +
  
  
  theme_classic(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold"),
    strip.text = element_text(size = 12),  # chamber labels
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    legend.key.width = unit(1.5, "cm")
  )

# Display the plot
print(Bulk_Density_data_plot)
```
```{r}
library(dplyr)

Bulk_Density_Data %>%
  group_by(Pile) %>%                     # Group by Control/Experimental
  summarise(mean_moisture = mean(grams.cm.3))  # Calculate mean

```




Chamber Elevation Data: 

```{r}
chamber_elevation <- read.csv("C:/Users/KAUFMADA/Documents/R_Files/windrow-fluxes-co2-model-improvements/windrow-fluxes-co2-model-improvements/data_raw/Chamber_Elevation.csv")

chamber_elevation_after <- chamber_elevation %>%
  filter(Turning_Status == "After")

Chamber_elevation_plot <- ggplot(chamber_elevation_after, aes(x = DOY, y = Chamber_Elevation, group = Chamber, color = Pile)) +
  
  # Points per chamber
  geom_point(aes(group = Chamber), size = 2, alpha = 0.7) +

  # Vertical lines: black for sampling
  geom_vline(xintercept = floor(c( 249, 262, 276, 290)), 
             linetype = "dashed", color = "black", size = 0.3) +
  
  # Vertical lines: red for turning
  geom_vline(xintercept = floor(c( 262, 290)), 
             linetype = "dashed", color = "red", size = 0.4) +

  # Labels and formatting
  labs(
    title = "Chamber Elevation",
    subtitle = " Colored by Treatment",
    x = "Day of Year (DOY)",
    y = "Meters",
    color = "Turning Regime"
  ) +
  
  
  theme_classic(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold"),
    strip.text = element_text(size = 12),  # chamber labels
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    legend.key.width = unit(1.5, "cm")
  )

# Display the plot
print(Chamber_elevation_plot)

```




```{r}

chamber_elevation_after %>%
  group_by(Pile) %>%                     # Group by Control/Experimental
  summarise(mean_elevation = mean(Chamber_Elevation))  # Calculate mean

```

```{r}

library(dplyr)

weather_data <- weather_data %>%
  filter(DOY_decimal > 152 & DOY_decimal < 292 )


```



```{r}

at_watchdog <- ggplot(weather_data, aes(x = DOY_decimal)) +
  
  geom_point(aes(y = TMPA, color = "Soil Temp approx 10 cm"), size = .5, alpha = 0.7) +
  geom_point(aes(y = TMP, color = "Air Temp "), size = .5, alpha = 0.7) +

  labs(
    title = "Air and Soil Temperature (10 cm depth)",
    x = "Day of Year (DOY)",
    y = "Temperature (°F)",
    color = "Variable"
  ) +
  theme_classic(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold"),
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    legend.key.width = unit(1.5, "cm")
  )

print(at_watchdog)

```


```{r}

weather_data %>%
  summarise(mean_moisture = mean(TMP))  # Calculate mean

```



```{r}
library(ggplot2)

# Rescale FCO2 for plotting if needed (adjust the factor to match the VWCB scale roughly)
FCO2_Cleaned$FCO2_scaled <- FCO2_Cleaned$FCO2_DRY.LIN / 100  # Adjust as needed

soil_moisture_watchdog <- ggplot(FCO2_Cleaned, aes(x = DOY)) +

  # VWCB points
  geom_point(aes(y = VWCB), color = "blue", size = 2, alpha = 0.7) +

  # FCO2 line on secondary axis
  geom_line(aes(y = FCO2_scaled), color = "darkgreen", size = 1) +

  # Sampling dates (black dashed)
  geom_vline(xintercept = floor(c(159, 173, 186, 191, 208, 222, 234, 249, 262, 276, 290)), 
             linetype = "dashed", color = "black", size = 0.3) +

  # Turning dates (red dashed)
  geom_vline(xintercept = floor(c(159, 186, 208, 234, 262, 290)), 
             linetype = "dashed", color = "red", size = 0.4) +

  scale_y_continuous(
    name = "Soil Moisture (VWCB, %)",
    sec.axis = sec_axis(~ . * 10, name = expression(F[CO[2]] ~ "(µmol m"^{-2}~s^{-1}~")"))
  ) +

  labs(
    title = "Soil Moisture and FCO₂ Overlay",
    x = "Day of Year (DOY)"
  ) +

  theme_classic(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold"),
    axis.title.y.right = element_text(color = "darkgreen"),
    axis.title.y.left = element_text(color = "blue")
  )

# Show plot
print(soil_moisture_watchdog)

```




Pile Volume

```{r}

surface_area_volume <- read.csv("C:/Users/KAUFMADA/Documents/CTD/2023 All Surface Area and Volume.csv")


volume_plot <- ggplot(surface_area_volume, aes(x = Date, y = Volume.m.3, color = Pile)) +
  
  # Points per chamber
  geom_point(aes(group = Pile), size = 2, alpha = 0.7) +

  # Vertical lines: black for sampling
  geom_vline(xintercept = floor(c(159, 173, 186, 191, 208, 222, 234, 249, 262, 276, 290)), 
             linetype = "dashed", color = "black", size = 0.3) +
  
  # Vertical lines: red for turning
  geom_vline(xintercept = floor(c(159, 186, 208, 234, 262, 290)), 
             linetype = "dashed", color = "red", size = 0.4) +

  # Labels and formatting
  labs(
    title = "Pile Volume",
    subtitle = " Colored by Treatment",
    x = "Day of Year (DOY)",
    y = "M^3",
    color = "Turning Regime"
  ) +
  
  
  theme_classic(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold"),
    strip.text = element_text(size = 12),  # chamber labels
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    legend.key.width = unit(1.5, "cm")
  )

# Display the plot
print(volume_plot)

```
```{r}
library(dplyr)

surface_area_volume %>%
  group_by(Pile) %>%                     # Group by Control/Experimental
  summarise(mean_volume = mean(Volume.m.3))  # Calculate mean

```



Pile Surface Area - 2d 

```{r}
surface_area_plot <- ggplot(surface_area_volume, aes(x = Date, y = Area_2D.m.2, color = Pile)) +
  
  # Points per chamber
  geom_point(aes(group = Pile), size = 2, alpha = 0.7) +

  # Vertical lines: black for sampling
  geom_vline(xintercept = floor(c(159, 173, 186, 191, 208, 222, 234, 249, 262, 276, 290)), 
             linetype = "dashed", color = "black", size = 0.3) +
  
  # Vertical lines: red for turning
  geom_vline(xintercept = floor(c(159, 186, 208, 234, 262, 290)), 
             linetype = "dashed", color = "red", size = 0.4) +

  # Labels and formatting
  labs(
    title = "Pile Area",
    subtitle = " Colored by Treatment",
    x = "Day of Year (DOY)",
    y = "M^2",
    color = "Turning Regime"
  ) +
  
  
  theme_classic(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold"),
    strip.text = element_text(size = 12),  # chamber labels
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    legend.key.width = unit(1.5, "cm")
  )

# Display the plot
print(surface_area_plot)

```


Research Question: How does turning frequency influence the physical and chemical properties of compost windrows over time, and how do these properties explain trace gas emissions (e.g., CO₂, CH₄, N₂O) in both control and treatment piles?

Lets begin by modeling emissions based on our known environmental drivers - which drivers explain the most variability in our measured values, what interactions between variables are most important. Does this differ by pile (treatment)?


```{r}
# Plot the first histogram
hist(FCO2_Cleaned$FCO2_DRY.LIN, breaks = "FD", 
     main = "FCO2 Hist", xlab = "FCO2 umols/m^2/s")
```
Log transforming data
```{r}
FCO2_Cleaned <- FCO2_Cleaned %>%
  filter(FCO2_DRY.LIN > 0) %>%  # Remove rows with 0 or negative values
  mutate(log_FCO2_DRY.LIN = log(FCO2_DRY.LIN))
```

```{r}
# Plot the first histogram
hist(FCO2_Cleaned$log_FCO2_DRY.LIN, breaks = "FD", 
     main = "log FCO2 Hist", xlab = "FCO2 umols/m^2/s")
```

that looks way better

Scaling the variables
```{r}

FCO2_Cleaned_scaled <- FCO2_Cleaned %>%
  mutate(un_scaled_DOY = DOY) %>%  # Save unscaled DOY for later use (e.g., autocorrelation)
  mutate(across(where(is.numeric) & !matches("DOY"), scale))

# Step 2: Convert character variables to factors
FCO2_Cleaned_scaled_categorized <- FCO2_Cleaned_scaled %>%
  mutate(across(where(is.character), as.factor))


# Step 3: Fill NA in numeric columns with median value
FCO2_Cleaned_scaled_categorized <- FCO2_Cleaned_scaled_categorized %>%
  mutate(across(
    where(is.numeric),
    ~ ifelse(is.na(.), median(., na.rm = TRUE), .)
  ))

```

Variables scaled - median value used to fill NA: 

Initial Full Model will include the following variables 

Pile - C or E for control or experimental
Chamber_Corrected -> chamber value (corrected for a switch in port between chamber 4-6)
Chamber_Elevation -> average elevation of chamber used to correct for amount of material contributing to flux under the chamber
air_temp -> air temp measured at eddy covar station half a mile away from pile - we also can use tmpa which is the air temp from local weather station 
TMPA -> air temp atlocal watchdog station
VWCB -> soil moisture from sensor in watchdog, can tell us about soil moisture conditions. 
HMD -> humiditiy
air_pressure -> bar from ec station 
BAR -> pressure from watchdog station 
TA.range -> the range in temp of the air measured in the long term chambers
SWC_1.initial_value -> volumemetric water content measured by stevens probe
TS_1.initial_value -> temp in pile from stevens probe at start of measurement
FN2O_DRY.LIN -> lin flux of n2o 
FCH4_DRY.LIN -> lin flux of ch4
FH2O -> flux of h2o
BulkDensity -> g/cm^3
DaysSinceLastTurn -> days since pile was turned 
TotalTurns -> total turns of the pile at each point in time 

and of course Fco2_Dry.lin

```{r}
# vars with interaction 
interaction_terms <- c("TMPA", "SWC_1.initial_value", "TS_1.initial_value")

# All predictors to include 
predictors <- c(
  "TMPA", "HMD", "BAR",
  "SWC_1.initial_value", "TS_1.initial_value",
  "BulkDensity", "DaysSinceLastTurn", "Chamber_Elevation"
)
                      
```

```{r}
# Variables to use in additive form only
additive_only <- setdiff(predictors, interaction_terms)
# Build interaction part
interaction_formula <- paste("Pile *", interaction_terms, collapse = " + ")

# Build additive part
additive_formula <- paste(additive_only, collapse = " + ")

# Combine into full formula
fixed_formula <- as.formula(
  paste("log_FCO2_DRY.LIN ~", interaction_formula, "+", additive_formula)
)
```

```{r}

library(dplyr)

FCO2_Cleaned_scaled_categorized <- FCO2_Cleaned_scaled_categorized %>%
  arrange(Chamber_Corrected, un_scaled_DOY) %>%   # make sure it's ordered
  group_by(Chamber_Corrected) %>%
  mutate(time_index = row_number()) %>%           # time index unique within each chamber
  ungroup()

library(nlme)

full_model <- lme(
  fixed = fixed_formula,
  random = ~1 | Chamber_Corrected,
  correlation = corAR1(form = ~ time_index | Chamber_Corrected),
  data = FCO2_Cleaned_scaled_categorized,
  na.action = na.exclude
)


```

Full model has been run, lets look at the summary

```{r}
summary(full_model)

```
Looking at the significant P>0,05 predictors + interactions and un loging them we can see there effect size

```{r}
coefs <- summary(full_model)$tTable

coef_df <- as.data.frame(coefs)
coef_df$Variable <- rownames(coef_df)

coef_df$exp_Estimate <- exp(coef_df$Value)
coef_df$percent_change <- (coef_df$exp_Estimate - 1) * 100

coef_df %>%
  select(Variable, Value, percent_change, `p-value`)



```

Here we can see the " effect size of different predictors and interactions"

The largest predictor by some margin was temperature of the pile followed by Days since last turning, and total turns (though this is going to be autocorrelated with DOY and time), Then Chamber elevation 

Interacion Terms 

PileE TMPA - 3 percent
PileE SWC_1 10 - the effect of swc was 10 percent higher on co2 flux in the e pile
PileE TS_1 20 - the effect of temp was 20 percent higher on co2 flux in the e pile

```{r}
library(performance)
print(r2(full_model))
```

Most of the variance is just between the chambers with a conditional r^2 of 0.186
Our environmental drivers do not explain most of the variance in emissions. 

```{r}
library(ggeffects)

ggpredict(full_model, terms = c("TMPA [all]", "Pile")) 
ggpredict(full_model, terms = c("HMD [all]", "Pile"))         # Humidity
ggpredict(full_model, terms = c("BAR [all]", "Pile"))         # Pressure
ggpredict(full_model, terms = c("SWC_1.initial_value [all]", "Pile"))  # Water content
ggpredict(full_model, terms = c("TS_1.initial_value [all]", "Pile"))   # Internal pile temp
ggpredict(full_model, terms = c("BulkDensity [all]", "Pile")) # Density
ggpredict(full_model, terms = c("DaysSinceLastTurn [all]", "Pile"))
ggpredict(full_model, terms = c("Chamber_Elevation [all]", "Pile"))


```


```{r}
library(MuMIn)
r.squaredGLMM(full_model)

```

Very similar to the above values: 




```{r}
library(dplyr)

FCO2_Cleaned %>%
  filter(!is.na(TS_1.initial_value)) %>%       # Remove NA values
  group_by(Pile) %>%                     # Group by Control/Experimental
  summarise(mean_TS = mean(TS_1.initial_value))  # Calculate mean

```

